<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
   <style>
    #divCard{
      transition: all 1s ease;
    }
    .offcanvas{
      transition: all 1.5s ease;
    }
    </style>
    <title>DETALLE</title>
  </head>
  <body>
    <nav class="navbar bg-body-tertiary shadow-lg mb-4">
      <div class="container-fluid p-3 row">
        <a href="" class="navbar-brand col-lg-auto d-flex justify-content-center W-25"> <img src="Multimedia/logo.jpeg" width="70px" height="70px" alt="Logo"> </a>
        <div class="d-flex col-lg-auto justify-content-center gap-2">
          <a href="index.html" class="navbar-brand p-2 rounded text-uppercase itemNav"><small>home</small></a>
          <a href="#" onclick="paginaNueva(this)" class="navbar-brand p-2 rounded text-uppercase itemNav" name="hombre"><small>hombre</small></a>
          <a href="#" onclick="paginaNueva(this)" class="navbar-brand p-2 rounded text-uppercase itemNav" name="mujer"><small>mujer</small></a>
          <a href="#" onclick="paginaNueva(this)" class="navbar-brand p-2 rounded text-uppercase itemNav" name="niño"><small>niño</small></a>
        </div>
        <div class="col-lg-auto d-flex align-items-center justify-content-center">
          <div class="hstack gap-3">
            <div class="dropdown mx-1">
              <button class="btn btn-light dropdown-toggle text-capitalize" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="iniciarSesion"></button>
              <ul class="dropdown-menu visually-hidden dropMenu">
                <li><button class="dropdown-item d-flex align-items-center" type="button" id="cerrarSesion">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-box-arrow-in-left me-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0z"/>
                    <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
                  </svg>
                  Cerrar Sesion
                </button></li>
              </ul>
            </div>
            <div class="vr"></div>
            <button class="btn btn-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" id="carrito">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-cart-fill" viewBox="0 0 16 16">
                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
              </svg>
            </button>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
              <div class="offcanvas-header">
                <h5 class="offcanvas-title text-uppercase" id="offcanvasRightLabel">productos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
              </div>
              <div class="offcanvas-body" id="canvasBody"></div>
              <button class="btn btn-outline-danger mb-4 mx-4" id="botonCompra">Finalizar compra</button>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="mx-1 bg-white container position-absolute top-20 end-0 z-3 dropMenu" style="display: none; max-width:400px;"></div>
    <button class="btn btn-dark align-self-start m-3 d-flex align-items-center" onclick="volverAtras()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
      </svg>
      Volver atras
    </button>
    <div class="col text-center mx-1 me-3">
        <div class="row row-cols-2 d-flex justify-content-center mb-3" id="contenedor">
            <div class="card border-0 w-75 col d-flex align-items-center" id="divCard" style="max-width: 550px;">
                <section class="d-flex justify-content-center">
                    <div id="carouselExampleDark" class="carousel carousel-dark slide w-50" data-bs-ride="carousel">
                        <div class="carousel-indicators" id="carouselBotones"></div>
                        <div class="carousel-inner text-center" id="carousel"></div>
                    </div>
                  </section>
                <div class="card-body align-items-center w-100" id="divCardBody">
                    <h5 class="card-title" id="nombre">NOMBRE</h5>
                    <p class="card-text" id="descripcion">descripcion del producto sea el tamaño que sea</p>
                    <div class="card-text d-flex justify-content-center gap-2 m-4" id="tallas"></div>
                    <p class="card-text m-4" id="precio"> precio</p>
                    <button class="btn btn-outline-danger" id="agregarCarrito">Agregar al carrito</button>
                </div>
            </div>
        </div> 
    </div>
    <footer class="footer">
      <div class="container-fluid bg-secondary text-center">
        <div class="row">
          <div class="col-lg-12 col-md-12">
            <div id="map" class="map map-home w-100 mt-3" style="height:300px;"></div>
            <button class="btn btn-light m-2" onclick="setFullMap()">Tu ubicacion</button>
          </div>
          <div class="col-lg-12 p-2 m-auto">
            <h6>Derechos de autor</h6>
            <p>(c) 2024 Tienda Imanol. Todos los derechos reservados.</p>
          </div>
          <div class="col-lg-12 p-2 justify-content-around d-inline-flex flex-wrap">
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Nombre de la empresa</a></h6>
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Contacto</a></h6>
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Aviso legal</a></h6>
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Privacidad del sitio</a></h6>
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Condiciones de uso</a></h6>
            <h6><a href="footer.html" target="_blank" class="nav-link p-2">Condiciones de venta</a></h6>
          </div>
        </div>
      </div>
    </footer>
    <script>
      document.getElementById("agregarCarrito").addEventListener("click",comprobarSesion)
      document.getElementById("carrito").addEventListener("click", mostrarProductosEnCarrito);
      document.getElementById("botonCompra").addEventListener("click",abrirCarrito);
      let dropMenu = document.querySelectorAll(".dropMenu");
      if (localStorage.getItem("sesion") == "true") {
        dropMenu[0].classList.remove("visually-hidden");
      }
      let divCard = document.getElementById("divCard")
      divCard.addEventListener("mouseover",function(){
        divCard.classList.add("shadow-lg");
      })
      divCard.addEventListener("mouseleave",function(){
        divCard.classList.remove("shadow-lg");
      })

      function mostrarProductosEnCarrito() {
        let canvasBody = document.getElementById("canvasBody")
        if (localStorage.getItem("sesion") == "true") {
          if (localStorage.getItem("Productos")) {
            productos = JSON.parse(localStorage.getItem("Productos"));
          }
          //Reset del carrito donde estan todos los prodcutos
          canvasBody.innerHTML = "";
          productos.forEach((producto) => {
            //Acceder al JSON con el producto(id)
            cargarConId(producto.id);
          });
        }
      }

      async function cargarConId(id) {
        try {
          const json = await cargarJSON();
          mostrarConId(json, id);
        } catch (e) {
          console.log(e);
        }
      }

      function mostrarConId(json, idPr) {
        let canvasBody = document.getElementById("canvasBody")
        var div = document.createElement("div");
        var imagen = document.createElement("img");
        var nombre = document.createElement("p");
      
        div.classList =
          "row container w-75 d-flex align-items-center justify-content-center";
        imagen.src = json[idPr - 1].imagenes[0];
        imagen.classList = "col w-50";
        nombre.innerHTML = json[idPr - 1].nombre;
        nombre.classList = "col";
        div.appendChild(imagen);
        div.appendChild(nombre);
        canvasBody.appendChild(div);
      }
      

      let itemsNav = document.querySelectorAll(".itemNav");
      itemsNav.forEach(item => {
        item.addEventListener("mouseover",function(){
          item.classList += "shadow bg-danger bg-danger-gradient gbg-opacity-10 text-white";
        })
        item.addEventListener("mouseleave",function(){
          item.classList.remove("shadow")
          item.classList.remove("bg-danger")
          item.classList.remove("bg-danger-gradient")
          item.classList.remove("bg-opcaity-10")
          item.classList.remove("text-white")
        })
      })
      let idProducto;
      let parametrosUrl = new URLSearchParams(window.location.search);
      let id = parametrosUrl.get("id");
      function volverAtras(){
        history.back()
      }
      function mostrar(json) {
        idProducto=json[id - 1].id
        let contador = 0;
        let carousel = document.getElementById("carousel");
        let carouselBotones = document.getElementById("carouselBotones");
        let nombreProducto = document.getElementById("nombre");
        let descripcionProducto = document.getElementById("descripcion");
        let tallas = document.getElementById("tallas");
        let precioProducto = document.getElementById("precio");

        nombreProducto.innerHTML = json[id - 1].nombre
        descripcionProducto.innerHTML = json[id - 1].descripcion
        if(json[id - 1].talla != ""){
          json[id - 1].talla.forEach(talla => {
            let botonTalla = document.createElement("button");
            botonTalla.classList = "btn btn-light tallaProducto"
            botonTalla.innerHTML = talla
            botonTalla.addEventListener("click",tallaSeleccionada)
            tallas.appendChild(botonTalla)
          })
        }
        
        precioProducto.innerHTML = json[id - 1].precio + " &#8364"
        precioProducto.classList = "fw-bold"
        json[id - 1].imagenes.forEach(imagen => {
            let boton = document.createElement("button");
            boton.type = "button"
            boton.setAttribute('data-bs-target', '#carouselExampleDark');
            boton.setAttribute('data-bs-slide-to', contador.toString());
            boton.setAttribute('aria-label', 'Slide ' + (contador + 1).toString());
            let div = document.createElement("div");
            div.setAttribute('data-bs-interval', '3000');
            if(contador == 0){
              boton.className = 'active';
              boton.setAttribute('aria-current','true')
              div.classList = "carousel-item active"
            } else {
              div.classList = "carousel-item"
            }
            contador++;
            carouselBotones.appendChild(boton)
            let img = document.createElement("img");
            img.classList="d-block w-100";
            img.src = imagen;
            div.appendChild(img)
            carousel.appendChild(div)

        })
      }
      function tallaSeleccionada(e){
        if(e.target.classList.contains("btn-dark")){
          e.target.classList.remove("btn-dark");
          e.target.classList.add("btn-light");
        } else {
          e.target.classList.remove("btn-light");
          e.target.classList.add("btn-dark");
        }
        e.target.parentElement.querySelectorAll(".tallaProducto").forEach(talla => {
          if(talla.classList.contains("btn-dark") && talla.textContent != e.target.textContent){
            talla.classList.remove("btn-dark");
            talla.classList.add("btn-light");
          }
        })
        if(document.getElementById("divCardBody").lastElementChild.textContent != "Agregar al carrito"){
          document.getElementById("divCardBody").lastElementChild.remove()
        }
      }
      function paginaNueva(e){
        sessionStorage.setItem("seccion",e.name)
        window.open("productos.html", '_self');
    }
      ///////
      function abrirCarrito(){
        if(localStorage.getItem("sesion") == "false"){
          openNewWindow();
        } else {
          window.open("carritoCompra.html", '_self');
        }
      }
      async function cargar() {
        try {
          const json = await cargarJSON();
          mostrar(json);
        } catch (e) {
          console.log(e);
        }
      }
      async function cargarJSON() {
        let doc = "articulos.json";
        const respuesta = await fetch(doc);
        const json = await respuesta.json();
        return json;
      }
      
      
      function comprobarSesion(e) {
        var tallaElegida = "Unica";
        e.target.parentElement.querySelectorAll("button").forEach((talla) => {
          if (talla.classList.contains("btn-dark")) {
            tallaElegida = talla.textContent;
          }
        });
        if (localStorage.getItem("sesion") == "true") {
          if (
            tallaElegida == "Unica" &&
            e.target.parentElement.querySelectorAll("button").length > 0
          ) {
            p = document.createElement("p");
            p.classList = "text-danger m-1";
            p.innerHTML = "Debes seleccionar una talla";
            if (e.target.parentElement.lastElementChild == e.target) {
              e.target.parentElement.appendChild(p);
            }
          } else {
            agregarAlCarrito(
              e.target.id,
              e.target.previousElementSibling.textContent.split(" ")[0],
              tallaElegida
            );
            Notification.requestPermission()
              .then((resultado) => {
                mostrarNotificacion(resultado);
              });
              function mostrarNotificacion(resultado) {
                if (resultado == "granted") {
                  new Notification("Producto añadido correctamente", {
                  });
                }
              }
            mostrarProductosEnCarrito();
          }
        } else {
          openNewWindow();
        }
      }
      function agregarAlCarrito(id,precio,talla) {
        const almacenamientoJSON = {
          id,
          precio,
          talla
        };
        productos = JSON.parse(localStorage.getItem("Productos")) || [];
        //agregar el nuevo producto al objeto de productos
        productos.push(almacenamientoJSON);
        //Volcado de datos al localStorage
        localStorage.setItem("Productos", JSON.stringify(productos));
      }
      function openNewWindow() {
        var ancho = 600;
        var alto = 800;
        var y = window.top.outerHeight / 2 + window.top.screenY - alto / 2;
        var x = window.top.outerWidth / 2 + window.top.screenX - ancho / 2;
        window.open(
          "inicioSesion.html",
          "ventanaNueva",
          "width=" + ancho + ",height=" + alto + ",top=" + y + ",left=" + x
        );
      }
      function crearDatosLocalStorage(){
        if(!localStorage.getItem("nombreSesion")){
          localStorage.setItem("nombreSesion","Iniciar Sesion");
        }
        if(!localStorage.getItem("sesion")){
          localStorage.setItem("sesion",false);
        }
        iniciarSesion.innerHTML = localStorage.getItem("nombreSesion");
      }

      let osmUrl; // url
        let map; // mapa
        let markerGroup; // marcadores
        window.addEventListener('load', setMap())

        function setMap() {
            // Creamos el mapa
            osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                osm = L.tileLayer(osmUrl, { maxZoom: 18, attribution: osmAttrib });
            // Esto de setView sirve para situar la cámara, las coordenadas desde las que 
            map = L.map('map').setView([40.3877449,-3.6298866], 13).addLayer(osm);
            markerGroup = L.layerGroup().addTo(map);
            showMap();
        }

        // Comprueba si has hecho el mapa entero
        function setFullMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showFullMap);
            }
            else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        // Añade el marcador de la tienda
        function showMap() {
            L.marker([40.3877449,-3.6298866]).addTo(map)
                .bindPopup('Mountain Bourd Jand')
                .openPopup()
                .addTo(map);
        }

        // Añade el marcador de tu localización
        function showFullMap(position) {
            L.marker([position.coords.latitude, position.coords.longitude]).addTo(map)
                .bindPopup('Ubicacion actual')
                .openPopup()
                .addTo(map);
        }

      crearDatosLocalStorage();
      cargar();
    
    </script>
  </body>
</html>
